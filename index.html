// --- ä¿®æ”¹å¾Œçš„ Pusher ç›£è½éƒ¨åˆ† ---
channel.bind('my-event', function(data) {
    if (data.message === 'spin' && data.reward) {
        console.log("æ”¶åˆ°æŠ½çŽæŒ‡ä»¤ï¼Œçµæžœç‚º: " + data.reward);
        spinQueue.push(data.reward); // å°‡ç‰¹å®šçµæžœæ”¾é€²éšŠåˆ—
        processQueue();
    }
});

let spinQueue = []; // æ”¹ç‚ºå„²å­˜çµæžœçš„é™£åˆ—

function processQueue() {
    if (spinQueue.length > 0 && !isSpinning) {
        const nextReward = spinQueue.shift(); // å–å‡ºä¸‹ä¸€å€‹é å®šçµæžœ
        startSpin(nextReward);
    }
}

function startSpin(targetReward) {
    isSpinning = true;
    resDiv.innerText = "ðŸŽŠ æ­£åœ¨æŽ¥æ”¶çµæžœ... ðŸŽŠ";

    // æ‰¾åˆ°è©²çŽé …åœ¨ options ä¸­çš„ index
    const targetIdx = options.indexOf(targetReward);
    if (targetIdx === -1) { isSpinning = false; return; } // å®‰å…¨æª¢æŸ¥

    const segmentAngle = 360 / options.length;
    const stopAngle = 360 - (targetIdx * segmentAngle) - (segmentAngle / 2);
    currentRotation += (10 * 360) + (stopAngle - (currentRotation % 360));
    
    canvas.style.transform = `rotate(${currentRotation}deg)`;
    
    setTimeout(() => {
        resDiv.innerText = "ðŸŽŠ " + targetReward + " ðŸŽŠ";
        setTimeout(() => {
            isSpinning = false;
            processQueue();
        }, 3000);
    }, 5200);
}
